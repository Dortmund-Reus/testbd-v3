<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>设备添加与文件烧写</title>
    <link rel="stylesheet" href="style.css">
    <script src="js/jquery-3.5.1.js"></script>
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script> -->
    <script src="js/tagsinput.js" type="text/javascript" charset="utf-8"></script>
</head>

<body>
    <!-- 顶部 -->
    <h2 class="top">设备烧写</h2>
    <!-- 主体 -->
    <div class="box_container">
        <!-- 设备选择 -->
        <div class="box_item">
            <fieldset id=select_device>
                <legend><h3>选择设备</h3></legend>
                <!-- <h3 class="box_item_top">选择设备</h3> -->
                <form action="#" class="box_item_main">
                    <label for="device-show" class="box_item_main_label">所选设备：
                        <input type="text" value="" id="device-show" style="height:25px" >
                    </label>
                    <div class="line-20"></div>
                    <!--城市选择-->
                    <label for="device-show">城市选择：
                        <select id="site" onchange="showBoard(this)">
                            <option>Sites</option>
                        </select>
                    </label>
                    <br />
                    <div class="line-20"></div>
                    <!--板子选择-->
                    <label for="device-show">选择板子：
                        <select id="board" onchange="showNodes(this)">
                            <option>Architecures</option>
                        </select>
                    </label>
                    <br />
                    <div class="line-20"></div>
                    <!--节点选择-->
                    <label for="device-show">选择节点：
                        <select id="device_id" onchange="selectNodes(this)">
                            <option>Nodes</option>
                        </select>
                    </label>
                    <br />
                    <div class="line-20"></div>
                    <button type="button" class="btn" onClick="showDevice()">
                        <div class="btn_front add">添加设备</div>
                    </button>
                </form>

            </fieldset>
        </div>
        <!-- 已选择的设备列表 -->
        <div class="box_item">
            <fieldset id="device_list">
                <legend><h3>已选择设备列表</h3></legend>
                <!-- <h3 class="box_item_top">已选择设备列表</h3> -->
                <label for="nodes-show">
                    <div class="box_item2_main_item">
                        <div class="box_item2_main_item_title">选择设备节点:</div>
                        <!-- <input type="text" id="device-show"> -->
                        <div class="box">
                            <div class="tagsinput-primary form-group">
                                <input data-role="tagsinput" id="nodes-show" />
                            </div>
                        </div>
                    </div>
                </label>
                <br/>

                <label for="nodes-show">
                    <div class="box_item2_main_item">
                        <div class="box_item2_main_item_title">选择firmware:</div>
                        <!-- <input type="text" id="device-show"> -->
                        <div class="box">
                            <div class="tagsinput-primary form-group">
                                <input data-role="tagsinput" id="files-show" />
                                <div class="line-20"></div>
                                <button type="button" class="btn" id="add_firmware">
                                    <div class="btn_front">添加firmware</div>
                                </button>
                                <button type="button" class="btn" id="delete_device">
                                    <div class="btn_front">删除所选设备</div>
                                </button>
                                <button type="button" class="btn" id="reset">
                                    <div class="btn_front">重新选择设备</div>
                                </button>
                            </div>
                        </div>
                    </div>
                </label>

                <table>
                    <!-- here goes our data! -->
                </table>
            </fieldset>
        </div>
        <!-- 已上传的文件列表 -->
        <div class="box_item">
            <fieldset id="upload_list">
                <legend><h3> 已上传的文件列表</h3></legend>
                <!-- <h3 class="box_item_top"> 已上传的文件列表</h3> -->
                <div >
                    <label for="board-select">
                        <div class="box_item2_main_item">
                            <div class="box_item2_main_item_title">设备架构类型:</div>
                            <select id="board-select">
                                <option>Architecures</option>
                            </select>
                        </div>
                    </label>
                    </br>
                    <label for="file-show">
                        <div class="box_item2_main_item">
                            <div class="box_item2_main_item_title">您要上传的是:</div>
                            <input type="text" id="file-show">
                        </div>
                    </label>
                    <div class="line-20"></div>
                    <div style="margin-left:20%"> 
                        <button type="button" class="btn" id="upload_burn">
                            <div class="btn_front">上传文件</div>
                        </button>
                        <button type="button" class="btn add" id="add_confirm">
                            <div class="btn_front">确认添加</div>
                        </button></div>
                </div>
            </fieldset>
        </div>
        <!-- tinysim的编译 -->
        <div class="box_item">
            <fieldset id="compile">
                <legend><h3> Tinysim源码编译</h3></legend>
                <!-- <h3 class="box_item_top"> Tinysim源码编译</h3> -->
                <div >
                    <label for="board-select2">
                        <div class="box_item2_main_item">
                            <div class="box_item2_main_item_title">设备架构类型:</div>
                            <select id="board-select2">
                                <option>Architecures</option>
                            </select>
                        </div>
                    </label>
                    </br>
                    <label for="file-show">
                        <div class="box_item2_main_item">
                            <div class="box_item2_main_item_title">您要上传的是:</div>
                            <input type="text" id="tinysim-file-show">
                        </div>
                    </label>
                    <div class="line-20"></div>
                    <div style="margin-left:20%"> 
                        <button type="button" class="btn" id="upload_compile">
                            <div class="btn_front">上传源码</div>
                        </button>
                        <button type="button" class="btn" id="compile_btn">
                            <div class="btn_front">开始编译</div>
                        </button>
                        <button type="button" class="btn" id="download_btn">
                            <div class="btn_front">上传文件</div>
                        </button>
                    </div>
                </div>
            </fieldset>
        </div>
        <!-- <div class="box_item">
            <fieldset id="logs">
                <legend><h3>实时日志</h3></legend>
                <div id="log_div">
                    <textarea id="messages" name="story" rows="10" cols="100" readonly="readonly"
                    style="background-attachment: fixed; background-repeat: no-repeat; border-style: solid; border-color: #FFFFFF">
                    </textarea>
                </div> 
            </fieldset>
        </div> -->
        <div class="box_item">
            <fieldset id="logs">
                <legend><h3>实时日志</h3></legend>
                <!-- <div id="messages"></div> -->
                <div class="test_box" contenteditable="false" id = "messages"><br /></div>  
            </fieldset>
        </div>
        <div style="margin:0 auto">
            <div style="margin:0 auto">
                <button class="btn" style="height:40px;width:100px" id="submit" onClick="sendBurnRequest()"><div class="btn_front">确认提交</div></button>
            </div>
                <button class="btn" style="height:40px;width:100px" id="downloadLogs"><div class="btn_front">下载日志</div></button>
            </div>
        </div>
        
    </div>
    <script type="module">
    
        import { Debugout } from './node_modules/debugout.js/dist/debugout.js'
        const el = (id) => document.getElementById(id);
   
        let debugouts = [];
        el('downloadLogs').onclick = () => {
            debugouts.forEach((s) => {
                s.downloadLog();
            });
            //bugout.downloadLog();
        }
   
        //const bugout = new Debugout();
       // bugout.logFilename = "a.txt"; // just for test

        let ws_url = "ws://kubernetes.tinylink.cn/linklab/device-control-v2/user-service/api/ws";

        let ws = new WebSocket(ws_url, user_token);
      //  console.log(user_token);
        ws.onopen=function(evt){
            ws.send(user_token);
            document.getElementById('messages').innerHTML
                    = 'Connection established';
           // bugout.log("Connection established");
        };
        let sr = el("messages");

        
        ws.onmessage = function(evt) {
            let json_obj = eval("(" + evt.data + ")");
            let msg_type = json_obj.data.type;
            //分三种情况:
            //1.TaskAllocateMsg  -->  TaskAllocateMsg
            //2.TaskLogMsg  -->  TaskLogMsg
            //3.TaskEndMsg  -->  TaskEndRunMsg
            if(msg_type == "TaskAllocateMsg"){
                let a = json_obj.data.data.deviceid;
                //如果是第一条发回来的数据，应该据此生成一个debugout对象
                const bugout = new Debugout;
                //设置该bugout对象的文件名
                bugout.logFilename = JSON.stringify(a) + ".txt";
                debugouts.push(bugout);
                bugout.log("Received Message: " + evt.data);
                //console.log(JSON.stringify(a));
            } else {
                //如果是后续的数据，就写入对应的文件里面去
                //根据taskIndex判断是哪个debugout对象
                let i = json_obj.data.taskindex - 1;
               // console.log(typeof(i));
                // i = taskIndex - 1即为数组下标
                debugouts[i].log("Received Message: " + evt.data);
            }
            
            // //对于接受到的信息，应该分两种情形来处理
            // if(a == null){
                
            // } else {
                
            // }
            //另外，有json_obj.data.data不存在的情况
            
            
            document.getElementById('messages').innerHTML
                    += '<br />' + evt.data;
            
            sr.scrollTop = sr.scrollHeight;   // 内容滚动到最后一行
        };

   </script>
    <script src="js/functions.js"></script>
    <script src="js/binarytransport.js"></script>
    <script src="js/upload.js"></script>
    <script src="js/sendHttp.js"></script>
    <script src="js/device.js"></script>
    <script src="js/main.js"></script>
    
    
    <script src="js/build_table.js"></script>

    
</body>

</html>